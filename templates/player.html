<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebBridgeBot Media Player - {{.ChatID}}</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #222;
            color: #fff;
            overflow: hidden; /* Prevent scrolling */
            position: relative; /* Establish stacking context */
            height: 100vh;
        }
        h1 {
            color: #00aaff;
            font-size: 2.5rem;
            font-weight: 700;
            margin: 20px 0;
            text-align: center;
            z-index: 2; /* Position above the background */
            position: relative;
            text-shadow: 3px 3px 8px rgba(0, 0, 0, 0.7); /* Add shadow to the title */
        }
        #videoPlayer, #audioPlayer, #imageViewer {
            max-width: 90%;
            max-height: 60vh;
            display: none;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            z-index: 2; /* Position above the background */
            position: relative;
        }
        .button-container {
            display: flex;
            justify-content: center;
            width: 100%;
            margin: 20px 0;
            gap: 15px;
            z-index: 3; /* Increased z-index to ensure it's above other elements */
            position: relative;
        }
        .button {
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: 600;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            z-index: 3; /* Increased z-index to ensure it's above other elements */
            position: relative;
        }
        .button:hover {
            background-color: #0056b3;
        }
        #status {
            font-size: 1.5rem;
            margin: 15px 0;
            text-align: center;
            color: #aaa;
            z-index: 3; /* Increased z-index to ensure it's above other elements */
            position: relative;
            text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.6); /* Add shadow to the status text */
        }
        #audioMotionContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1; /* Ensure it is behind all other content */
            pointer-events: none; /* Allow clicks to pass through */
        }
    </style>
</head>
<body>
<h1>WebBridgeBot</h1>
<p id="status">Chat ID: {{.ChatID}}; Waiting for media...</p>
<video id="videoPlayer" controls></video>
<audio id="audioPlayer" controls></audio>
<img id="imageViewer" />
<div class="button-container">
    <button id="reloadButton" class="button">Reload</button>
    <button id="fullscreenButton" class="button">Fullscreen</button>
</div>

<div id="audioMotionContainer"></div> <!-- Ensure this is at the bottom for proper stacking -->

<script type="module">
    import AudioMotionAnalyzer from "https://cdn.skypack.dev/audiomotion-analyzer?min";
    document.addEventListener('DOMContentLoaded', () => {
        const videoPlayer = document.getElementById('videoPlayer');
        const audioPlayer = document.getElementById('audioPlayer');
        const imageViewer = document.getElementById('imageViewer');
        const fullscreenButton = document.getElementById('fullscreenButton');
        const reloadButton = document.getElementById('reloadButton');
        const statusText = document.getElementById('status');
        let ws;
        let latestMediaData = null; // Store the full data object

        const setupWebSocket = () => {
            const wsAddress = 'ws://' + window.location.host + '/ws/{{.ChatID}}';
            ws = new WebSocket(wsAddress);

            ws.addEventListener('message', handleWebSocketMessage);
            ws.addEventListener('error', handleWebSocketError);
            ws.addEventListener('open', handleWebSocketOpen);
            ws.addEventListener('close', handleWebSocketClose);
        };

        const handleWebSocketOpen = () => {
            console.log('WebSocket connection opened.');
        };

        const handleWebSocketMessage = (event) => {
            const data = JSON.parse(event.data);
            console.log('Message from server: ', data);
            latestMediaData = data; // Store the latest media data
            playMedia(data);
        };

        const handleWebSocketClose = () => {
            console.log('WebSocket closed. Attempting to reconnect...');
            // Only attempt reconnect if not explicitly closed by another action
            setTimeout(setupWebSocket, 3000);
        };

        const handleWebSocketError = (error) => {
            console.error('WebSocket encountered an error: ', error.message);
            // It's usually good to close explicitly on error if not handled otherwise
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
        };

        const updateUIForMedia = (playerToShow, playersToHide, data) => {
            // Pause and hide all other players
            playersToHide.forEach(player => {
                if (player.pause) player.pause();
                player.style.display = 'none';
            });
            imageViewer.style.display = 'none'; // Ensure image viewer is hidden if not active

            // Set the display style for the active player
            if (playerToShow) {
                 playerToShow.style.display = 'block';
            }

            // Clear image src when hiding
            imageViewer.src = '';

            // Update button visibility and onclick handlers
            reloadButton.style.display = 'inline-block'; // Reload button always visible for media
            fullscreenButton.style.display = 'none'; // Default to hidden

            if (data.mimeType.startsWith('video')) {
                statusText.textContent = 'Playing Video...';
                fullscreenButton.style.display = 'inline-block';
                fullscreenButton.onclick = () => enterFullScreen(videoPlayer);
            } else if (data.mimeType.startsWith('audio')) {
                statusText.textContent = 'Playing Audio...';
                // Fullscreen button hidden for audio
            } else if (data.mimeType.startsWith('image')) {
                statusText.textContent = 'Viewing Image... Click to view full screen.';
                reloadButton.style.display = 'none'; // No reload for images needed usually
                fullscreenButton.style.display = 'inline-block';
                fullscreenButton.onclick = () => enterFullScreen(imageViewer);
            } else {
                statusText.textContent = 'Unsupported media type.';
                reloadButton.style.display = 'none';
                fullscreenButton.style.display = 'none';
            }
            reloadButton.onclick = () => playMedia(data); // Always set reload to the current media
        };

        const playMedia = (data) => {
            // Hide all media elements first
            videoPlayer.style.display = 'none';
            audioPlayer.style.display = 'none';
            imageViewer.style.display = 'none';

            // Clear any previous media sources
            videoPlayer.src = '';
            audioPlayer.src = '';
            imageViewer.src = '';

            // Clean up or re-initialize AudioMotionAnalyzer if it was active
            if (window.audioMotion && window.audioMotion.analyzer) {
                window.audioMotion.analyzer.disconnect();
                window.audioMotion.analyzer = null; // Clear reference
                document.getElementById("audioMotionContainer").innerHTML = ''; // Clear canvas
            }

            const uniqueUrl = data.url + '?nocache=' + new Date().getTime(); // Add nocache for fresh load

            if (data.mimeType.startsWith('video')) {
                updateUIForMedia(videoPlayer, [audioPlayer, imageViewer], data);
                loadAndPlayMedia(videoPlayer, uniqueUrl);
            } else if (data.mimeType.startsWith('audio')) {
                updateUIForMedia(audioPlayer, [videoPlayer, imageViewer], data);
                loadAndPlayMedia(audioPlayer, uniqueUrl);
                initAudioMotion(audioPlayer); // Re-initialize for new audio
            } else if (data.mimeType.startsWith('image')) {
                updateUIForMedia(imageViewer, [videoPlayer, audioPlayer], data);
                loadImage(imageViewer, uniqueUrl);
            } else {
                console.log('Unsupported media type: ', data.mimeType);
                statusText.textContent = 'Unsupported media type.';
                updateUIForMedia(null, [videoPlayer, audioPlayer, imageViewer], data); // Hide all
            }
        };

        const loadAndPlayMedia = (player, url) => {
            player.src = url;
            player.load();

            const attemptPlay = () => {
                player.play().then(() => {
                    statusText.textContent = ''; // Clear status after successful playback
                }).catch(error => {
                    if (error.name === 'NotAllowedError') {
                        statusText.textContent = 'Please click on the page to play media.';
                        document.body.addEventListener('click', attemptPlay, { once: true });
                    } else {
                        console.error('Error playing media: ', error);
                        statusText.textContent = 'Error playing media. Please try reloading.';
                    }
                });
            };

            attemptPlay();
        };

        const initAudioMotion = (audioElement) => {
            console.log('Initializing AudioMotionAnalyzer');
            try {
                // Ensure container is empty before creating new analyzer
                document.getElementById("audioMotionContainer").innerHTML = '';

                const audioMotion = new AudioMotionAnalyzer(document.getElementById("audioMotionContainer"), {
                    source: audioElement,
                    height: window.innerHeight,
                    width: window.innerWidth,
                    ansiBands: false,
                    showScaleX: false,
                    bgAlpha: 0.5,
                    overlay: true,
                    mode: 1,
                    frequencyScale: "log",
                    radial: true,
                    showPeaks: false,
                    showBgColor: true,
                    radialInvert: true,
                    channelLayout: "dual-vertical",
                    smoothing: 0.7
                });
                window.audioMotion = { analyzer: audioMotion }; // Store reference globally for cleanup

                window.addEventListener('resize', () => {
                    if (window.audioMotion && window.audioMotion.analyzer) {
                        window.audioMotion.analyzer.setCanvasSize(window.innerWidth, window.innerHeight);
                    }
                });

                const attemptPlayAudioMotion = () => {
                    audioElement.play().then(() => {
                        statusText.textContent = '';
                    }).catch(error => {
                        if (error.name === 'NotAllowedError') {
                            statusText.textContent = 'Please click on the page to start audio visualization.';
                            document.body.addEventListener('click', attemptPlayAudioMotion, { once: true });
                        } else {
                            console.error('Error with AudioMotion playback: ', error);
                            statusText.textContent = 'Error with audio playback. Please try reloading.';
                        }
                    });
                };
                attemptPlayAudioMotion();
            } catch (error) {
                console.error('AudioMotionAnalyzer error: ', error);
                statusText.textContent = 'Error initializing audio visualization.';
            }
        };

        const loadImage = (imageElement, url) => {
            imageElement.src = url;
            imageElement.onload = () => {
                statusText.textContent = ''; // Clear status after image loads
            };
            imageElement.onerror = () => {
                statusText.textContent = 'Error loading image.';
            };
        };

        const enterFullScreen = (element) => {
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.webkitRequestFullscreen) { /* Safari */
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) { /* IE11 */
                element.msRequestFullscreen();
            } else if (element.mozRequestFullScreen) { /* Firefox */
                element.mozRequestFullScreen();
            }
        };

        imageViewer.addEventListener('click', () => {
            enterFullScreen(imageViewer);
        });

        // Event listeners for buttons
        reloadButton.addEventListener('click', () => {
            if (latestMediaData) {
                playMedia(latestMediaData); // Re-trigger playMedia with the last known media data
            }
        });

        // Initial setup
        setupWebSocket();
    });

</script>
</body>
</html>
